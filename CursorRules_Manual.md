# Cursor Rules 運用マニュアル

このルールセットを導入すると、Cursorエディタが **「自律型AIエージェント」** に進化します。
チャットでコマンドを入力するだけで、AIが設計・実装・監査を自動で行います。

---

## 目次

1. [クイックスタート](#1-クイックスタート)
2. [コマンド早見表](#2-コマンド早見表)
3. [基本の開発フロー](#3-基本の開発フロー)
4. [Security Profiles (L1-L4)](#4-security-profiles-l1-l4)
5. [コピペで使えるテンプレート](#5-コピペで使えるテンプレート)
6. [複数チャットでの運用技](#6-複数チャットでの運用技)
7. [よくある質問](#7-よくある質問)
8. [絶対に守るべき3つのルール](#8-絶対に守るべき3つのルール)

---

## 1. クイックスタート

### ステップ1: 配置

`.cursor/` フォルダをあなたのプロジェクトルートにコピーしてください。

```
your-project/
├── .cursor/        ← これをコピー
│   ├── rules/
│   └── templates/
├── .cursorrules    ← 古いCursor用（あれば一緒にコピー）
└── src/
```

### ステップ2: Cursorを再起動

Cursorを **完全に閉じて、もう一度開く**。これでルールが有効になります。

### ステップ3: 動作確認

チャットで `@help` と入力してください。ナビゲーションが表示されれば成功です。

### ステップ4: CURSOR.md の作成（推奨）

チャットで `@init` と入力すると、AIがプロジェクトの前提知識ファイル（`CURSOR.md`）を作成してくれます。
このファイルがあると、AIが技術スタックやビジネスルールを理解した状態で作業を始めてくれます。

---

## 2. コマンド早見表

「今やりたいこと」からコマンドを選んでください。

| 今の状態 | やりたいこと | コマンド |
| :--- | :--- | :--- |
| 🆕 **新規** | 「こんな機能ほしいな...」 | `@spec` |
| 📐 **設計** | 「仕様は決まった！設計しよう」 | `@design` |
| 🔨 **実装** | 「設計できた！作るぞ！」 | `@impl` |
| 🐛 **バグ** | 「動かない！直して！」 | `@impl` |
| 🧪 **テスト** | 「テストを実行したい」 | `@test` |
| 🧹 **掃除** | 「コードを綺麗にしたい」 | `@refactor` |
| 🔍 **レビュー** | 「コードをチェックして」 | `@review` |
| 🚢 **出荷** | 「リリースしていい？」 | `@ship` |
| 🛡️ **監査** | 「セキュリティ大丈夫？」 | `@audit` |
| ❓ **迷子** | 「次なにすればいい？」 | `@help` |
| 🔄 **再開** | 「昨日の続きから」 | `@onboard` |
| 🔚 **終了** | 「今日はここまで！」 | `@wrap-up` |

---

## 3. 基本の開発フロー

開発はこの順番で進めます。**全部コマンドを入力するだけ。**

```
@spec → @design → @impl → @test → @ship
```

| 順番 | コマンド | 何をするの？ |
| :---: | :--- | :--- |
| 1 | `@spec` | 何を作るか決める。「提案して」と言えばAIが全部書いてくれる |
| 2 | `@design` | DB・API・画面構成を設計。「全部やって」でOK |
| 3 | `@impl` | 設計通りにコーディング。セキュリティも自動で考慮 |
| 4 | `@test` | テストを実行（Smart Testing: 変更関連のみ）。なければ自動作成 |
| 5 | `@ship` | **最終関門**。セキュリティ・品質を全チェック |

> **重要**: いきなり `@impl` しない！必ず `@design` で設計図を作ってから。

---

## 4. Security Profiles (L1-L4)

プロジェクトのセキュリティ要件に応じて、監査の厳格さを調整できます。

### プロファイル一覧

| Level | 名称 | 対象 | 説明 |
|-------|------|------|------|
| **L1** | Startup | MVP/Prototype | 認証とPII保護のみ。高速開発優先。 |
| **L2** | Standard | SaaS標準 | **推奨デフォルト**。バランス型。 |
| **L3** | Enterprise | 金融/医療 | 全10層の監査を適用。厳格。 |
| **L4** | National | 国家機密/防衛 | Air-Gap必須。最高レベル。 |

### 設定方法

1. `@init` 実行時に選択
2. または `CURSOR.md` の `Security Profile` セクションを直接編集

### 各レベルの監査範囲

| 観点 | L1 | L2 | L3 | L4 |
|------|:--:|:--:|:--:|:--:|
| A) セキュリティ基本 | ✅ | ✅ | ✅ | ✅ |
| B) マルチテナント/RLS | - | ✅ | ✅ | ✅ |
| C) インフラ/運用 | - | - | ✅ | ✅ |
| D) サプライチェーン | - | - | ✅ | ✅ |
| E) 非同期/外部連携 | - | - | ✅ | ✅ |
| F) データ整合性/性能 | - | ✅ | ✅ | ✅ |
| G) フロント | - | - | ✅ | ✅ |
| H) 仕様との整合 | - | ✅ | ✅ | ✅ |
| I) テスト | - | ✅ | ✅ | ✅ |
| 手動承認必須 | - | - | - | ✅ |

---

## 5. コピペで使えるテンプレート

AIへの指示に迷ったら、以下をコピーして使ってください。

### 🆕 新機能を作りたいとき

```
@spec
# 新機能の要望
「タスク管理機能」を追加したいです。
ユーザーがタスクを追加・編集・削除できるようにしたい。
詳細な要件は、一般的なWebアプリの構成で**全て提案してください**。
```

### 📐 設計をお願いしたいとき

```
@design
要件定義が完了しました。
DB設計、API設計、画面構成を**全て提案してください**。
```

### 🐛 バグを直したいとき

```
@impl
# バグ修正依頼
以下の事象が発生しています。原因を調査して修正してください。
- 事象: ログイン画面で「送信」を押しても反応がない
- 期待値: ダッシュボードに遷移すること
```

### 🧹 コードを綺麗にしたいとき

```
@refactor
対象: src/features/auth/AuthService.ts

上記のファイルが読みづらいです。
機能は一切変えずに、可読性を上げるためにリファクタリングしてください。
```

### 🚢 リリース前の最終確認

```
@ship
実装が終わりました。
リリースしても大丈夫か、全ての監査を実行してください。
問題があれば、修正案もセットで教えてください。
```

### 🔄 昨日の続きから再開

```
@onboard
昨日の続きから作業を再開します。
現在の状況と、次にやるべきことを教えてください。
```

### 🔚 今日の作業を終了

```
@wrap-up
今日の作業はここまでです。
現在の状態を保存して、次回スムーズに再開できるようにしてください。
```

---

## 6. 複数チャットでの運用技

会話が長くなるとAIの動作が重くなり、精度が落ちます。
**「1つの機能＝1つのチャット」** と考え、以下のフローで切り替えるのが最適です。

### 運用フロー

```
1. 作業完了 → @wrap-up を実行
2. 記憶が memory/checkpoint.md に保存される
3. 新しいチャットを開く
4. @onboard で状態を復元
```

### checkpoint.md の内容

```markdown
# Checkpoint
- Date: 2026-02-05
- Phase: Implementation
- Task: ユーザー認証機能の実装
- Next: 統合テストの作成
- Security: L2 Standard
```

この情報があれば、新しいチャットでもスムーズに再開できます。

---

## 7. よくある質問

### Q: ルールが効いているか確認したい
チャットで `@help` と入力してください。ナビゲーションが表示されれば有効です。

### Q: コマンドを打っても反応がない
Cursorを完全に再起動してください。それでもダメなら `.cursor/rules/` フォルダがプロジェクトルートにあるか確認。

### Q: Security Profileを変更したい
`CURSOR.md` の `Security Profile` セクションで Level を変更してください（L1〜L4）。

### Q: 他のプロジェクトでも使いたい
`.cursor` フォルダをコピーするだけでOK。プロジェクトごとにカスタマイズも可能です。

### Q: チームで共有したい
`.cursor` フォルダをGitリポジトリに含めて共有してください。全員が同じルールで開発できます。

### Q: チャットが重くなってきた
会話が長くなるとAIの動作が遅くなります。以下のフローで解決してください。

```
作業完了 → @wrap-up → 新しいチャット → @onboard
```

---

## 8. 絶対に守るべき3つのルール

1. **迷ったら `@design`** - いきなりコードを書かせない。設計図を作る。
2. **出荷前は `@ship`** - 人間がチェックする前に、AIの監査を通す。
3. **チャットは軽く** - 長くなったら `@wrap-up` → 新規チャット。

---

## 全コマンド一覧

### 開発フロー
| コマンド | 説明 |
| :--- | :--- |
| `@spec` | 要件定義。「何を作るか」を決める |
| `@design` | 設計。DB/API/画面構成を決める |
| `@impl` | 実装。コードを書く |
| `@test` | テスト実行・自動生成 |
| `@review` | コードレビュー（自動修正付き） |
| `@ship` | 出荷判定。全項目チェック |

### 監査・品質
| コマンド | 説明 |
| :--- | :--- |
| `@audit` | 厳格セキュリティ監査（10層チェック） |
| `@sec` | セキュリティ＆ライセンスチェック |
| `@perf` | パフォーマンス監査 |
| `@qa` | UX・SEO・データ整合性チェック |

### ユーティリティ
| コマンド | 説明 |
| :--- | :--- |
| `@help` | 困ったときのナビゲーション |
| `@init` | プロジェクト初期化（CURSOR.md作成、Security Profile設定） |
| `@config` | Security Profile確認・変更 |
| `@onboard` | プロジェクト再開・状況把握（Checkpoint復元） |
| `@wrap-up` | セッション終了・状態保存（Checkpoint作成） |
| `@refactor` | 安全なリファクタリング |
| `@consult` | AIによる改善提案 |
| `@sync` | プロジェクト整合性チェック |

---

## セキュリティ機能

このルールセットは、以下のセキュリティ機能を **自動で** 適用します。

| 機能 | 説明 |
| :--- | :--- |
| **RLS必須** | データベース操作時、アクセス制御を強制 |
| **脅威モデリング** | 実装前に「攻撃者の視点」でリスク分析 |
| **秘密情報チェック** | APIキー等のハードコードを検出 |
| **監査証跡** | 監査結果を `docs/audit_reports/` に自動保存 |
| **10層チェック** | A〜I + 基本原則の包括的監査 |

---

## ファイル構成

```
.cursor/
├── rules/                  # AIへの指示ルール
│   ├── 000-core.mdc       # 基本ルール（常時適用）
│   ├── 001-planning.mdc   # 計画フェーズ
│   ├── 002-coding.mdc     # 実装フェーズ
│   ├── 003-audit.mdc      # 監査フェーズ
│   └── workflow-*.mdc     # 各コマンドの動作定義
└── templates/              # ドキュメントの雛形
    ├── CURSOR.md          # プロジェクト知識ベース
    ├── requirements.md    # 要件定義テンプレート
    ├── architecture.md    # 設計テンプレート
    ├── schema.md          # DB設計テンプレート
    └── api.md             # API設計テンプレート

memory/
└── checkpoint.md          # セッション状態保存（@wrap-upで作成）
```

---

## ライセンス

MIT License - 自由に使ってください。
